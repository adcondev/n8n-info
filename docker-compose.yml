services:
  #################################################################
  # SERVICIO 1: LA CAJA FUERTE (Base de Datos PostgreSQL)
  # Aqu√≠ es donde vivir√° toda la informaci√≥n de manera segura.
  #################################################################
  postgres:
    image: postgres:17-alpine  # Usamos la versi√≥n 'alpine' porque es muy ligera (ocupa poco espacio).
    restart: unless-stopped    # Si falla, intenta revivir autom√°ticamente.
    
    # Credenciales para crear la caja fuerte (vienen del archivo .env)
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    
    # üíæ PERSISTENCIA: Esto es lo que evita que pase lo de Render.
    # Mapeamos una carpeta virtual (volume) para que los datos sobrevivan al reinicio.
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Red privada: Solo n8n necesita hablar con la base de datos, nadie m√°s.
    networks:
      - n8n-internal
    
    # üè• SALUD: Verificaci√≥n autom√°tica.
    # Docker verificar√° que Postgres est√© lista antes de iniciar n8n.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5

  #################################################################
  # SERVICIO 2: EL CEREBRO (n8n)
  # La aplicaci√≥n donde creas tus flujos de trabajo.
  #################################################################
  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    
    # Exponemos el puerto 5678 para acceder a n8n
    ports:
      - "5678:5678"
    
    environment:
      # --- CONEXI√ìN A LA BASE DE DATOS ---
      # Le decimos a n8n: "No uses SQLite, usa la caja fuerte de arriba"
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres    # Nombre del servicio de arriba
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      
      # --- SEGURIDAD (CR√çTICO) ---
      # La llave para desencriptar las credenciales guardadas.
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      
      # --- CONFIGURACI√ìN GENERAL ---
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://${N8N_HOST}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE} # Importante para que los Cron (horarios) funcionen bien.
      
    # Guardamos archivos locales de n8n (no la DB, sino cach√© y configuraciones menores)
    volumes:
      - n8n_data:/home/node/.n8n
      
    # Red interna: Para hablar con Postgres de forma segura.
    networks:
      - n8n-internal
    
    # üö¶ ORDEN DE ARRANQUE:
    # "No inicies n8n hasta que Postgres est√© saludable".
    depends_on:
      postgres:
        condition: service_healthy

#################################################################
# DEFINICI√ìN DE INFRAESTRUCTURA
#################################################################
networks:
  n8n-internal:
    driver: bridge   # Red privada interna para n8n y PostgreSQL

volumes:
  n8n_data:       # Espacio en disco para n8n
  postgres_data:  # Espacio en disco para la DB (¬°Lo m√°s importante!)
