services:
  #################################################################
  # SERVICIO 1: LA CAJA FUERTE (Base de Datos PostgreSQL)
  # Aqu√≠ es donde vivir√° toda la informaci√≥n de manera segura.
  #################################################################
  postgres:
    # üì¶ IMAGE: Especifica qu√© versi√≥n de PostgreSQL usar
    # - postgres:17-alpine = Versi√≥n 17 de PostgreSQL en su variante "alpine"
    # - "alpine" es una versi√≥n minimalista de Linux (la capa base ocupa ~5MB vs ~100MB de versiones completas, pero la imagen completa de PostgreSQL es m√°s grande)
    # - Resultado: Base de datos potente pero que ocupa menos espacio en disco
    image: postgres:17-alpine
    
    # üîÑ RESTART: Define la pol√≠tica de reinicio del contenedor
    # - unless-stopped = Si el contenedor falla o se detiene, Docker lo reiniciar√° autom√°ticamente
    # - EXCEPTO si t√∫ lo detienes manualmente con "docker compose stop"
    # - Garantiza que tu base de datos est√© siempre disponible sin intervenci√≥n manual
    restart: unless-stopped
    
    # üîê ENVIRONMENT: Variables de entorno que configuran PostgreSQL al iniciar
    # Estas variables le dicen a PostgreSQL c√≥mo crear la base de datos inicial:
    # - POSTGRES_USER: Nombre del superusuario que tendr√° control total de la DB
    # - POSTGRES_PASSWORD: Contrase√±a para ese usuario (NUNCA uses contrase√±as d√©biles)
    # - POSTGRES_DB: Nombre de la base de datos que se crear√° autom√°ticamente
    # El s√≠mbolo ${} toma los valores desde el archivo .env (para mantener secretos seguros)
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    
    # üíæ VOLUMES: LA CLAVE DE LA PERSISTENCIA
    # Esto es lo que SOLUCIONA el problema de p√©rdida de datos de SQLite en Render:
    # - postgres_data = Nombre del volumen Docker (espacio en disco dedicado)
    # - /var/lib/postgresql/data = Carpeta dentro del contenedor donde Postgres guarda TODO
    # - El mapeo "postgres_data:/var/lib/postgresql/data" significa:
    #   "Guarda los datos en el disco f√≠sico del servidor, NO dentro del contenedor"
    # - Si el contenedor se destruye/reinicia, los datos SOBREVIVEN en el volumen
    # - An√°logo a conectar un disco duro externo: si cambias la computadora, tus archivos siguen ah√≠
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # üåê NETWORKS: Red virtual privada para comunicaci√≥n entre contenedores
    # - n8n-internal = Red aislada donde solo viven n8n y PostgreSQL
    # - Beneficio de seguridad: PostgreSQL NO es accesible desde internet directamente
    # - Solo n8n puede "hablar" con la base de datos a trav√©s de esta red privada
    # - Es como tener un t√∫nel secreto entre dos edificios
    networks:
      - n8n-internal
    
    # üè• HEALTHCHECK: Verificaci√≥n autom√°tica de que PostgreSQL est√° funcionando
    # Docker ejecuta este comando peri√≥dicamente para saber si la base de datos est√° "saludable"
    # - test: Comando que verifica si PostgreSQL responde (pg_isready = "¬øest√°s lista?")
    # - start_period: 30s = Espera 30 segundos antes de empezar a verificar (tiempo de arranque)
    # - interval: 10s = Verifica cada 10 segundos si est√° funcionando
    # - timeout: 5s = Si no responde en 5 segundos, marca como fallo
    # - retries: 5 = Intenta 5 veces antes de declarar el contenedor como "no saludable"
    # ¬øPor qu√© es importante? n8n esperar√° a que este healthcheck sea exitoso antes de iniciar
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      start_period: 30s
      interval: 10s
      timeout: 5s
      retries: 5

  #################################################################
  # SERVICIO 2: EL CEREBRO (n8n)
  # La aplicaci√≥n donde creas tus flujos de trabajo.
  #################################################################
  n8n:
    # üì¶ IMAGE: La imagen oficial de n8n desde Docker Hub
    # - n8nio/n8n:latest = Siempre usa la versi√≥n m√°s reciente de n8n
    # - "latest" se actualiza autom√°ticamente cuando haces "docker compose pull"
    # - Puedes especificar una versi√≥n fija (ej: n8nio/n8n:1.20.0) para mayor estabilidad
    image: n8nio/n8n:latest
    
    # üîÑ RESTART: Igual que PostgreSQL, reinicio autom√°tico en caso de fallo
    # - unless-stopped = Si n8n crashea o falla, Docker lo reinicia autom√°ticamente
    # - Garantiza alta disponibilidad de tu servicio de automatizaci√≥n
    restart: unless-stopped
    
    # üîå PORTS: Mapeo de puertos para acceder a n8n desde tu navegador
    # - Formato "puerto_host:puerto_contenedor"
    # - "5678:5678" significa: 
    #   * Puerto 5678 de tu servidor (izquierda) ‚Üí Puerto 5678 dentro del contenedor (derecha)
    # - Acceder√°s a n8n escribiendo en tu navegador: http://tu-servidor:5678
    # - El puerto de la izquierda puede cambiarse (ej: "8080:5678" para acceder en puerto 8080)
    ports:
      - "5678:5678"
    
    # üîê ENVIRONMENT: Variables que configuran c√≥mo funciona n8n
    environment:
      # --- CONEXI√ìN A LA BASE DE DATOS ---
      # Estas variables le dicen a n8n: "NO uses SQLite, usa PostgreSQL"
      
      # DB_TYPE: Tipo de base de datos a usar
      # - postgresdb = Le indica a n8n que use PostgreSQL en lugar de SQLite (default)
      # - Esta es LA variable que previene la p√©rdida de datos en entornos ef√≠meros
      - DB_TYPE=postgresdb
      
      # DB_POSTGRESDB_HOST: Direcci√≥n donde est√° PostgreSQL
      # - "postgres" = Nombre del servicio definido arriba (Docker resuelve este nombre autom√°ticamente)
      # - Docker hace "magia DNS": cuando n8n dice "postgres", Docker lo traduce a la IP del contenedor
      # - NO necesitas conocer la IP real, solo usar el nombre del servicio
      - DB_POSTGRESDB_HOST=postgres
      
      # DB_POSTGRESDB_PORT: Puerto donde PostgreSQL escucha conexiones
      # - 5432 = Puerto est√°ndar de PostgreSQL (por convenci√≥n)
      # - Comunicaci√≥n INTERNA entre contenedores (no requiere exposici√≥n externa)
      - DB_POSTGRESDB_PORT=5432
      
      # DB_POSTGRESDB_DATABASE: Nombre de la base de datos a la que conectarse
      # - Debe coincidir con POSTGRES_DB definido en el servicio postgres
      # - n8n buscar√° esta base de datos espec√≠fica dentro de PostgreSQL
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      
      # DB_POSTGRESDB_USER: Usuario para autenticarse en PostgreSQL
      # - Debe coincidir con POSTGRES_USER del servicio postgres
      # - n8n usar√° estas credenciales para leer/escribir en la base de datos
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      
      # DB_POSTGRESDB_PASSWORD: Contrase√±a del usuario
      # - Debe coincidir con POSTGRES_PASSWORD del servicio postgres
      # - Nunca pongas contrase√±as directamente aqu√≠, usa siempre ${VARIABLE} desde .env
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      
      # --- SEGURIDAD (CR√çTICO) ---
      
      # N8N_ENCRYPTION_KEY: La llave maestra para encriptar/desencriptar credenciales
      # - n8n guarda contrase√±as de APIs (Google, Slack, etc.) ENCRIPTADAS en la base de datos
      # - Esta clave es como la llave de una caja fuerte: sin ella, no puedes abrir nada
      # - ‚ö†Ô∏è IMPORTANTE: Si pierdes esta clave, perder√°s acceso a TODAS las credenciales guardadas
      # - Debe ser una cadena aleatoria larga y segura (generada con openssl rand -base64 32)
      # - Gu√°rdala en un gestor de contrase√±as: sin ella, tu n8n queda inutilizable
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      
      # --- CONFIGURACI√ìN GENERAL ---
      
      # N8N_HOST: El dominio o direcci√≥n donde estar√° accesible n8n
      # - Ejemplo: n8n.tudominio.com o la IP de tu servidor
      # - Usado para generar URLs correctas en webhooks y notificaciones
      - N8N_HOST=${N8N_HOST}
      
      # N8N_PORT: Puerto interno donde n8n escucha dentro del contenedor
      # - 5678 = Puerto est√°ndar de n8n (generalmente no necesitas cambiarlo)
      # - Diferente del puerto expuesto en "ports:" (aunque aqu√≠ coinciden)
      - N8N_PORT=5678
      
      # N8N_PROTOCOL: Protocolo para generar URLs (http o https)
      # - https = Recomendado para producci√≥n (requiere certificado SSL/TLS)
      # - Si usas un proxy reverso como Nginx o Caddy, ellos manejar√°n el HTTPS
      - N8N_PROTOCOL=https
      
      # NODE_ENV: Modo de ejecuci√≥n de la aplicaci√≥n Node.js
      # - production = Optimizaciones activadas, menos logs, mejor rendimiento
      # - development = M√°s logs de depuraci√≥n, recarga autom√°tica (solo para desarrollo)
      - NODE_ENV=production
      
      # WEBHOOK_URL: URL base para los webhooks que n8n generar√°
      # - Los webhooks son URLs donde servicios externos env√≠an datos a n8n
      # - Formato: https://tu-dominio/ (debe coincidir con N8N_HOST y N8N_PROTOCOL)
      # - Ejemplo: Si un cliente paga en Stripe, Stripe llama a https://tu-dominio/webhook/stripe
      - WEBHOOK_URL=https://${N8N_HOST}/
      
      # GENERIC_TIMEZONE: Zona horaria para ejecutar workflows con horarios espec√≠ficos
      # - Ejemplo: America/Mazatlan, Europe/Madrid, Asia/Tokyo
      # - Cr√≠tico para Cron jobs: "ejecutar todos los d√≠as a las 9 AM" usar√° esta zona horaria
      # - Lista completa: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      
    # üíæ VOLUMES: Almacenamiento persistente para archivos locales de n8n
    # - n8n_data = Volumen Docker para guardar configuraciones, cache, y archivos temporales
    # - /home/node/.n8n = Carpeta dentro del contenedor donde n8n guarda sus archivos locales
    # - Nota: La BASE DE DATOS est√° en PostgreSQL, aqu√≠ solo se guardan archivos auxiliares
    # - Archivos incluidos: configuraciones de UI, cache de nodos, logs locales
    volumes:
      - n8n_data:/home/node/.n8n
      
    # üåê NETWORKS: Conecta n8n a la misma red privada que PostgreSQL
    # - n8n-internal = Misma red definida en el servicio postgres
    # - Esto permite que n8n y postgres "se vean" y puedan comunicarse
    # - Sin esta red compartida, n8n no podr√≠a conectarse a la base de datos
    networks:
      - n8n-internal
    
    # üö¶ DEPENDS_ON: Define el orden de inicio de los contenedores
    # - postgres: condition: service_healthy = "No inicies n8n hasta que PostgreSQL est√© saludable"
    # - "saludable" significa que el healthcheck de postgres fue exitoso
    # - Previene errores de conexi√≥n: n8n no intentar√° conectarse antes de que postgres est√© lista
    # - Si postgres falla el healthcheck, n8n nunca se iniciar√° (evita arranques corruptos)
    depends_on:
      postgres:
        condition: service_healthy

#################################################################
# DEFINICI√ìN DE INFRAESTRUCTURA
# Aqu√≠ se definen recursos compartidos: redes y vol√∫menes
#################################################################

# üåê NETWORKS: Redes virtuales para comunicaci√≥n entre contenedores
networks:
  n8n-internal:
    # DRIVER: Tipo de red que Docker crear√°
    # - bridge = Red en modo "puente" (la m√°s com√∫n para contenedores en un mismo host)
    # - Funcionamiento: Crea una red privada aislada donde los contenedores pueden comunicarse
    # - Los contenedores en esta red pueden "verse" por nombre (postgres, n8n) autom√°ticamente
    # - Docker act√∫a como un "switch virtual" conectando solo estos dos contenedores
    # - Beneficio de seguridad: Esta red NO es accesible desde internet, solo entre contenedores
    # - An√°logo: Es como una red WiFi privada en tu casa, donde solo tus dispositivos se conectan
    driver: bridge

# üíæ VOLUMES: Espacios de almacenamiento persistente en el disco del servidor
# Los vol√∫menes Docker son carpetas especiales que sobreviven a la destrucci√≥n de contenedores
volumes:
  # n8n_data: Almacena archivos auxiliares de n8n (configuraciones, cache, logs)
  # - Tama√±o: Peque√±o (~100-500 MB dependiendo del uso)
  # - Contenido: Preferencias de UI, cache de nodos personalizados, archivos temporales
  # - NO contiene la base de datos (esa est√° en postgres_data)
  n8n_data:
  
  # postgres_data: Almacena TODA la base de datos de PostgreSQL
  # - Tama√±o: Variable (depende de cu√°ntos workflows y ejecuciones tengas)
  # - Contenido: Workflows, credenciales, historial de ejecuciones, configuraciones
  # - ‚ö†Ô∏è CR√çTICO: Este es el volumen m√°s importante - contiene TODOS tus datos
  # - Este volumen es LA SOLUCI√ìN al problema de p√©rdida de datos de SQLite en Render
  # - Ubicaci√≥n f√≠sica: Docker lo guarda en /var/lib/docker/volumes/ del servidor
  # - Backups: Para respaldar tu n8n, solo necesitas respaldar este volumen
  postgres_data:
